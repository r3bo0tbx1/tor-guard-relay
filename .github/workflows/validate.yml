name: ðŸ§± Build & Validation

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - 'tools/**'
      - '.github/workflows/release.yml'
      - '.github/workflows/validate.yml'

permissions:
  contents: read

jobs:
  lint:
    name: ðŸ” Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ” Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: ðŸ” Validate Dockerfile Syntax
        run: |
          echo "Validating Dockerfile build context..."
          docker build --no-cache --target builder -t tor-relay-test . 2>&1 | tee /tmp/docker-build.log || true
          
          # Check for common errors
          if grep -i "error" /tmp/docker-build.log; then
            echo "âŒ Dockerfile validation failed"
            exit 1
          fi
          
          echo "âœ… Dockerfile syntax valid"

      - name: ðŸ” Lint Shell Scripts
        run: |
          echo "Checking shell script syntax..."
          
          # Check entrypoint
          if [ -f docker-entrypoint.sh ]; then
            bash -n docker-entrypoint.sh || exit 1
            echo "âœ… docker-entrypoint.sh syntax valid"
          fi
          
          # Check all tools
          for script in tools/*; do
            if [ -f "$script" ]; then
              # Check if it's a shell script
              if head -1 "$script" | grep -q "^#!/"; then
                sh -n "$script" || exit 1
                echo "âœ… $script syntax valid"
              fi
            fi
          done
          
          # Check additional scripts
          for script in integration-check.sh relay-status.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" || exit 1
              echo "âœ… $script syntax valid"
            fi
          done

      - name: ðŸ” Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ðŸ” Run ShellCheck on Scripts
        run: |
          echo "Running ShellCheck on shell scripts..."
          
          # Check entrypoint with specific exclusions
          if [ -f docker-entrypoint.sh ]; then
            shellcheck -S warning docker-entrypoint.sh || true
          fi
          
          # Check tools directory
          find tools -type f -exec shellcheck -S warning {} \; || true
          
          echo "âœ… ShellCheck analysis complete"

      - name: ðŸ” Lint YAML Files
        run: |
          echo "Installing yamllint..."
          pip install yamllint
          
          echo "Validating YAML files..."
          for yaml in templates/*.yml docs/*.yml .github/workflows/*.yml .github/dependabot.yml; do
            if [ -f "$yaml" ]; then
              yamllint -d relaxed "$yaml" || exit 1
              echo "âœ… $yaml syntax valid"
            fi
          done

      - name: ðŸ” Validate JSON Files
        run: |
          echo "Validating JSON files..."
          for json in templates/*.json examples/*.json .github/*.json; do
            if [ -f "$json" ]; then
              python3 -m json.tool "$json" > /dev/null || exit 1
              echo "âœ… $json syntax valid"
            fi
          done

      - name: ðŸ“‹ Check Documentation
        run: |
          echo "Verifying required documentation files..."
          required_docs=(
            "README.md"
            "CHANGELOG.md"
            "SECURITY.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "LICENSE.txt"
          )

          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing documentation: $doc"
              exit 1
            fi
            echo "âœ… $doc exists"
          done
          
          # Check docs directory structure
          if [ -d "docs" ]; then
            echo "ðŸ“ Checking docs/ directory..."
            for doc in DEPLOYMENT.md BACKUP.md PERFORMANCE.md LEGAL.md MONITORING.md TOOLS.md; do
              if [ -f "docs/$doc" ]; then
                echo "âœ… docs/$doc exists"
              else
                echo "âš ï¸ docs/$doc missing (optional)"
              fi
            done
          fi

      - name: âœ… Lint Summary
        run: echo "âœ… All linting checks passed"

  build:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: âš™ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Image (amd64 for testing)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          load: true
          tags: tor-relay:test
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            BUILD_VERSION=test-${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ’¾ Save Image for Testing
        run: |
          docker save tor-relay:test -o /tmp/tor-relay-test.tar
          echo "Image size: $(du -h /tmp/tor-relay-test.tar | cut -f1)"

      - name: ðŸ“¤ Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/tor-relay-test.tar
          retention-days: 1

  integration:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: |
          docker load -i /tmp/tor-relay-test.tar
          docker image ls tor-relay

      - name: ðŸ§ª Run Container Smoke Test
        run: |
          echo "Starting container for smoke test..."
          
          # Start container in background (test mode)
          docker run -d \
            --name tor-test \
            -e ENABLE_METRICS=true \
            -e ENABLE_HEALTH_CHECK=true \
            tor-relay:test \
            /bin/sh -c "echo 'Test mode active'; sleep 60" || true

          # Wait for container to start
          sleep 5

      - name: âœ… Check Container Status
        run: |
          echo "Container status:"
          docker ps -a | grep tor-test || true
          
          echo ""
          echo "Container logs:"
          docker logs tor-test 2>&1 | head -30 || true

      - name: ðŸ§© Verify Tools Installation
        run: |
          echo "Checking installed tools..."
          docker run --rm tor-relay:test ls -la /usr/local/bin/ || exit 1
          
          echo ""
          echo "Available diagnostic tools:"
          docker run --rm tor-relay:test sh -c "ls -1 /usr/local/bin/ | grep -v '^tor$' | sort"

      - name: ðŸ§… Verify Tor Installation
        run: |
          echo "Checking Tor version..."
          TOR_VERSION=$(docker run --rm tor-relay:test tor --version | head -1)
          
          if [ -z "$TOR_VERSION" ]; then
            echo "âŒ Tor installation failed"
            exit 1
          fi
          
          echo "âœ… Tor installed: $TOR_VERSION"

      - name: ðŸ“‹ Verify File Structure
        run: |
          docker run --rm tor-relay:test sh -c "
            echo '=== Directory Structure ===' && \
            ls -la / | grep -E 'var|etc|usr' && \
            echo '' && \
            echo '=== Tools Directory ===' && \
            ls -la /usr/local/bin/ && \
            echo '' && \
            echo '=== Data Directory ===' && \
            ls -la /var/lib/tor 2>/dev/null || echo '(data dir empty, expected)' && \
            echo '' && \
            echo '=== Log Directory ===' && \
            ls -la /var/log/tor 2>/dev/null || echo '(log dir empty, expected)'
          "

      - name: ðŸ¥ Check Build Metadata
        run: |
          echo "Checking build metadata..."
          docker run --rm tor-relay:test cat /build-info.txt || exit 1

      - name: ðŸ”’ Verify Permissions
        run: |
          echo "Verifying directory permissions..."
          docker run --rm tor-relay:test sh -c "
            ls -ld /var/lib/tor | grep -q '^d.*tor tor' && echo 'âœ… /var/lib/tor permissions correct' || exit 1
            ls -ld /var/log/tor | grep -q '^d.*tor tor' && echo 'âœ… /var/log/tor permissions correct' || exit 1
          "

      - name: âœ… Integration Tests Summary
        run: echo "âœ… Integration tests completed successfully"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker stop tor-test 2>/dev/null || true
          docker rm tor-test 2>/dev/null || true

  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: ðŸ”’ Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tor-relay:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: ðŸ”’ Trivy Vulnerability Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tor-relay:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: âœ… Security Scan Complete
        run: echo "âœ… Security scan completed"

  test-matrix:
    name: ðŸ§ª Test Matrix
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        test-case:
          - 'help-flags'
          - 'file-permissions'
          - 'alpine-compatibility'
          - 'tool-executability'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: "ðŸ§ª Test: Help Flags"
        if: matrix.test-case == 'help-flags'
        run: |
          echo "Testing tool help flags..."
          
          for tool in health metrics status fingerprint view-logs net-check setup dashboard; do
            if docker run --rm tor-relay:test sh -c "command -v $tool" > /dev/null 2>&1; then
              echo "Testing $tool --help..."
              docker run --rm tor-relay:test $tool --help > /dev/null && echo "âœ… $tool --help works" || echo "âš ï¸ $tool --help failed"
            fi
          done

      - name: "ðŸ§ª Test: File Permissions"
        if: matrix.test-case == 'file-permissions'
        run: |
          echo "Verifying file permissions..."
          
          # Check tool executability
          docker run --rm tor-relay:test sh -c "
            for tool in health metrics status fingerprint view-logs net-check setup dashboard; do
              if command -v \$tool > /dev/null 2>&1; then
                test -x /usr/local/bin/\$tool && echo \"âœ… \$tool is executable\" || exit 1
              fi
            done
          "
          
          # Check entrypoint
          docker run --rm tor-relay:test sh -c "
            test -x /usr/local/bin/docker-entrypoint.sh && echo 'âœ… entrypoint is executable' || exit 1
          "

      - name: "ðŸ§ª Test: Alpine Compatibility"
        if: matrix.test-case == 'alpine-compatibility'
        run: |
          echo "Verifying Alpine base image..."
          
          docker run --rm tor-relay:test sh -c "
            cat /etc/os-release | grep -i alpine && echo 'âœ… Alpine base confirmed' || exit 1
            test -x /bin/sh && echo 'âœ… /bin/sh available' || exit 1
            apk --version > /dev/null 2>&1 && echo 'âœ… apk available' || exit 1
            command -v tor > /dev/null 2>&1 && echo 'âœ… tor available' || exit 1
          "

      - name: "ðŸ§ª Test: Tool Executability"
        if: matrix.test-case == 'tool-executability'
        run: |
          echo "Testing tool execution..."
          
          # Test each tool can execute without errors
          docker run --rm tor-relay:test sh -c "
            # Test health (should work even without Tor running)
            health --json > /dev/null 2>&1 || echo 'health requires Tor process'
            
            # Test metrics
            metrics --help > /dev/null 2>&1 && echo 'âœ… metrics executable' || exit 1
            
            # Test status
            status --help > /dev/null 2>&1 && echo 'âœ… status executable' || exit 1
          "

  summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [lint, build, integration, security, test-matrix]
    if: always()

    steps:
      - name: ðŸ“Š Generate Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§± Build & Validation Pipeline

          ## Pipeline Status
          - **Lint:** \`${{ needs.lint.result }}\`
          - **Build:** \`${{ needs.build.result }}\`
          - **Integration:** \`${{ needs.integration.result }}\`
          - **Security:** \`${{ needs.security.result }}\`
          - **Test Matrix:** \`${{ needs.test-matrix.result }}\`

          ## Build Information
          - **Branch:** \`${{ github.ref }}\`
          - **Commit:** \`${{ github.sha }}\`
          - **Run Number:** \`${{ github.run_number }}\`
          - **Date:** \`$(date -u +'%Y-%m-%dT%H:%M:%SZ')\`

          ## Checks Performed
          - âœ… Dockerfile validation with Hadolint
          - âœ… Shell script syntax checking
          - âœ… ShellCheck analysis
          - âœ… YAML validation
          - âœ… JSON validation
          - âœ… Documentation verification
          - âœ… Docker image build (multi-arch ready)
          - âœ… Container smoke test
          - âœ… Tor installation verification
          - âœ… Tool availability check
          - âœ… Permission verification
          - âœ… Security scanning with Trivy
          - âœ… Test matrix execution

          ## Next Steps
          If all checks pass:
          - Image is ready for production use
          - Release workflow will handle publishing to GHCR
          - Tag with semantic version to trigger release
          EOF

      - name: âœ… Build Pipeline Complete
        if: success()
        run: echo "âœ… All build and validation checks passed successfully"

      - name: âŒ Build Pipeline Failed
        if: failure()
        run: |
          echo "âŒ Build pipeline failed - check logs above for details"
          exit 1