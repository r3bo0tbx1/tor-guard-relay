name: ðŸ§± Build & Validation

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - 'tools/**'
      - '.github/workflows/build.yml'

permissions:
  contents: read

jobs:
  lint:
    name: ðŸ” Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Lint Dockerfile
        run: |
          # Check Dockerfile syntax
          docker build --dry-run . || exit 1
          echo "âœ“ Dockerfile syntax valid"

      - name: ðŸ” Lint Shell Scripts
        run: |
          # Check shell script syntax
          for script in docker-entrypoint.sh tools/* integration-check.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" || exit 1
              echo "âœ“ $script syntax valid"
            fi
          done

      - name: ðŸ” Lint YAML Files
        run: |
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq
            chmod +x yq
            export PATH=$PWD:$PATH
          fi

          # Check YAML syntax
          for yaml in templates/*.yml docs/*.yml .github/workflows/*.yml; do
            if [ -f "$yaml" ]; then
              yq eval '.' "$yaml" > /dev/null || exit 1
              echo "âœ“ $yaml syntax valid"
            fi
          done

      - name: ðŸ” Validate JSON Files
        run: |
          # Check JSON syntax
          for json in templates/*.json examples/*.json; do
            if [ -f "$json" ]; then
              python3 -m json.tool "$json" > /dev/null || exit 1
              echo "âœ“ $json syntax valid"
            fi
          done

      - name: ðŸ“‹ Check Documentation
        run: |
          # Verify key documentation files exist
          required_docs=(
            "README.md"
            "docs/DEPLOYMENT.md"
            "docs/BACKUP.md"
            "docs/PERFORMANCE.md"
            "docs/LEGAL.md"
            "SECURITY.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
          )

          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing documentation: $doc"
              exit 1
            fi
            echo "âœ“ $doc exists"
          done

      - name: âœ… Lint Summary
        run: echo "âœ… All linting checks passed"

  build:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Image (amd64 for testing)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          load: true
          tags: tor-relay:test
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            BUILD_VERSION=test-${{ github.run_number }}

      - name: ðŸ’¾ Save Image for Testing
        run: |
          docker save tor-relay:test -o /tmp/tor-relay-test.tar
          echo "Image size: $(du -h /tmp/tor-relay-test.tar | cut -f1)"

      - name: ðŸ“¤ Upload Image Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: /tmp/tor-relay-test.tar
          retention-days: 1

  integration:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: |
          docker load -i /tmp/tor-relay-test.tar
          docker image ls tor-relay

      - name: ðŸ§ª Run Container
        run: |
          # Start container in background (without actual Tor relay, just test setup)
          docker run -d \
            --name tor-test \
            --network host \
            -e ENABLE_METRICS=true \
            -e ENABLE_HEALTH_CHECK=true \
            -v /tmp/torrc:/etc/tor/torrc:ro \
            tor-relay:test \
            /bin/sh -c "echo 'Test mode'; sleep 30" || true

          # Wait for container to start
          sleep 5

      - name: âœ… Check Container Status
        run: |
          docker ps -a | grep tor-test || true
          docker logs tor-test 2>&1 | head -20 || true

      - name: ðŸ§© Run Integration Check
        run: |
          # Check tool availability inside image
          docker run --rm \
            -v $(pwd):/workspace:ro \
            tor-relay:test \
            ls -la /usr/local/bin/ || exit 1

          # List available tools
          docker run --rm tor-relay:test sh -c "ls -1 /usr/local/bin/ | grep -v '^tor$'" || true

      - name: ðŸ“‹ Verify File Structure
        run: |
          docker run --rm tor-relay:test sh -c "
            echo '=== Directory Structure ===' && \
            ls -la / | grep -E 'var|etc|usr' && \
            ls -la /usr/local/bin/ && \
            ls -la /var/lib/tor 2>/dev/null || echo '(data dir empty, expected)' && \
            ls -la /var/log/tor 2>/dev/null || echo '(log dir empty, expected)'
          "

      - name: ðŸ¥ Check Build Metadata
        run: |
          docker run --rm tor-relay:test cat /build-info.txt || exit 1

      - name: âœ… Integration Tests Summary
        run: echo "âœ… Integration tests completed"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker stop tor-test 2>/dev/null || true
          docker rm tor-test 2>/dev/null || true

  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: ðŸ”’ Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tor-relay:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: âœ… Security Scan Complete
        run: echo "âœ… Security scan completed"

  test-matrix:
    name: ðŸ§ª Test Matrix
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        test-case:
          - 'help-flags'
          - 'file-permissions'
          - 'alpine-compatibility'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Docker Image
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: ðŸ§ª Test: Help Flags
        if: matrix.test-case == 'help-flags'
        run: |
          # Test that tools respond to --help
          docker run --rm tor-relay:test sh -c "
            /usr/local/bin/health --help > /dev/null && echo 'âœ“ health --help' || true
            /usr/local/bin/metrics --help > /dev/null && echo 'âœ“ metrics --help' || true
            /usr/local/bin/dashboard --help > /dev/null && echo 'âœ“ dashboard --help' || true
          " || true

      - name: ðŸ§ª Test: File Permissions
        if: matrix.test-case == 'file-permissions'
        run: |
          # Verify executable permissions
          docker run --rm tor-relay:test sh -c "
            test -x /usr/local/bin/health && echo 'âœ“ health is executable' || exit 1
            test -x /usr/local/bin/metrics && echo 'âœ“ metrics is executable' || exit 1
            test -x /usr/local/bin/dashboard && echo 'âœ“ dashboard is executable' || exit 1
          "

      - name: ðŸ§ª Test: Alpine Compatibility
        if: matrix.test-case == 'alpine-compatibility'
        run: |
          # Verify Alpine base image
          docker run --rm tor-relay:test sh -c "
            cat /etc/os-release | grep -i alpine && echo 'âœ“ Alpine base confirmed' || exit 1
            test -x /bin/sh && echo 'âœ“ /bin/sh available' || exit 1
            apk --version > /dev/null 2>&1 && echo 'âœ“ apk available' || exit 1
          "

  summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [lint, build, integration, security, test-matrix]
    if: always()

    steps:
      - name: ðŸ“Š Generate Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§± Build & Validation Pipeline

          ## Pipeline Status
          - Lint: ${{ needs.lint.result }}
          - Build: ${{ needs.build.result }}
          - Integration: ${{ needs.integration.result }}
          - Security: ${{ needs.security.result }}
          - Test Matrix: ${{ needs.test-matrix.result }}

          ## Build Information
          - **Branch:** \`${{ github.ref }}\`
          - **Commit:** \`${{ github.sha }}\`
          - **Run Number:** \`${{ github.run_number }}\`
          - **Date:** \`$(date -u +'%Y-%m-%dT%H:%M:%SZ')\`

          ## Checks Performed
          - âœ… Dockerfile syntax validation
          - âœ… Shell script linting
          - âœ… YAML validation
          - âœ… JSON validation
          - âœ… Documentation verification
          - âœ… Docker image build
          - âœ… Container startup test
          - âœ… Tool availability check
          - âœ… Security scanning
          - âœ… File permissions check
          - âœ… Alpine compatibility check

          ## Next Steps
          If all checks pass:
          - Image is ready for testing
          - Release workflow will handle publishing to GHCR
          EOF

      - name: âœ… Build Pipeline Complete
        if: success()
        run: echo "âœ… All build checks passed successfully"

      - name: âŒ Build Pipeline Failed
        if: failure()
        run: |
          echo "âŒ Build pipeline failed"
          exit 1