name: âœ…âŒ› Validate

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
    paths:
      # ðŸ³ Core build and runtime logic
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - 'integration-check.sh'

      # ðŸ§© Tools and validation scripts
      - 'tools/*.sh'

      # âš™ï¸ CI/CD workflows
      - '.github/workflows/release.yml'
      - '.github/workflows/validate.yml'

      # ðŸ§± Template and config files
      - 'templates/**'
      - 'compose*.yml'
      - 'docker-compose*.yml'

      # ðŸ”’ Security or metadata configs
      - '.github/dependabot.yml'
      - '.github/renovate.json'
    paths-ignore:
      # ðŸ“ Documentation-only changes shouldn't trigger builds
      - '**/*.md'
      - '**/*.txt'
      - 'docs/**'
      - 'LICENSE*'
      - 'CONTRIBUTING*'
      - 'CHANGELOG.md'

permissions:
  contents: read

jobs:
  lint:
    name: ðŸ” Lint and Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ³ Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
        continue-on-error: true

      - name: ðŸ” Validate Dockerfile Syntax
        run: |
          echo "ðŸ³ Validating Dockerfile build context..."
          docker build --no-cache --target builder -t tor-relay-test . 2>&1 | \
            tee /tmp/docker-build.log || true
          if grep -i "error" /tmp/docker-build.log; then
            echo "âŒ Dockerfile validation failed"
            exit 1
          fi
          echo "âœ… Dockerfile syntax valid"

      - name: ðŸ“ Lint Shell Scripts
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” Checking Shell Script Syntax"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check main entrypoint script
          if [ -f docker-entrypoint.sh ]; then
            echo "ðŸ“„ Checking docker-entrypoint.sh..."
            bash -n docker-entrypoint.sh || exit 1
            echo "   âœ… docker-entrypoint.sh syntax valid"
          fi
          
          # Check integration test script
          if [ -f integration-check.sh ]; then
            echo "ðŸ“„ Checking integration-check.sh..."
            bash -n integration-check.sh || exit 1
            echo "   âœ… integration-check.sh syntax valid"
          fi
          
          echo ""
          echo "ðŸ“ Checking tools directory (.sh files)..."
          
          # Check if tools directory exists and has .sh files
          if [ ! -d "tools" ]; then
            echo "   âš ï¸  tools/ directory not found"
          elif [ -z "$(find tools -maxdepth 1 -type f -name '*.sh' 2>/dev/null)" ]; then
            echo "   âš ï¸  No .sh files found in tools/"
          else
            # Check all .sh files in tools/
            TOOL_COUNT=0
            for script in tools/*.sh; do
              [ -f "$script" ] || continue
              echo "ðŸ“„ Checking $(basename "$script")..."
              bash -n "$script" || exit 1
              echo "   âœ… $script syntax valid"
              TOOL_COUNT=$((TOOL_COUNT + 1))
            done
            echo ""
            echo "   âœ… All $TOOL_COUNT tool scripts validated"
          fi
          
          echo ""
          echo "ðŸŽ‰ Shell script syntax validation complete"

      - name: ðŸ”§ Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ðŸ”Ž Run ShellCheck on Scripts
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”Ž Running ShellCheck Static Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # ShellCheck main scripts
          if [ -f docker-entrypoint.sh ]; then
            echo "ðŸ” ShellCheck: docker-entrypoint.sh"
            shellcheck -S warning docker-entrypoint.sh || true
          fi
          
          if [ -f integration-check.sh ]; then
            echo "ðŸ” ShellCheck: integration-check.sh"
            shellcheck -S warning integration-check.sh || true
          fi
          
          # ShellCheck all .sh files in tools/
          if [ -d "tools" ]; then
            echo ""
            echo "ðŸ” ShellCheck: tools/*.sh"
            find tools -maxdepth 1 -type f -name "*.sh" -exec shellcheck -S warning {} \; || true
          fi
          
          echo ""
          echo "âœ… ShellCheck analysis complete"

      - name: ðŸŽ¯ Verify Tool Extensions
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ Verifying Tool File Extensions"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ ! -d "tools" ]; then
            echo "âš ï¸  tools/ directory not found - skipping check"
            exit 0
          fi
          
          MISSING_EXT=0
          NON_SH_COUNT=0
          SH_COUNT=0
          
          # Check all files in tools/
          for file in tools/*; do
            [ -f "$file" ] || continue
            
            filename=$(basename "$file")
            extension="${filename##*.}"
            
            # Check if it's a shell script (has shebang)
            if head -1 "$file" 2>/dev/null | grep -q "^#!/"; then
              if [ "$extension" != "sh" ]; then
                echo "âŒ Shell script missing .sh extension: $filename"
                MISSING_EXT=1
              else
                SH_COUNT=$((SH_COUNT + 1))
              fi
            else
              NON_SH_COUNT=$((NON_SH_COUNT + 1))
              echo "â„¹ï¸  Non-script file: $filename"
            fi
          done
          
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   â€¢ Shell scripts with .sh: $SH_COUNT"
          [ $NON_SH_COUNT -gt 0 ] && echo "   â€¢ Other files: $NON_SH_COUNT"
          echo ""
          
          if [ $MISSING_EXT -eq 1 ]; then
            echo "âŒ Some shell scripts are missing .sh extension"
            exit 1
          else
            echo "âœ… All shell scripts have proper .sh extension"
          fi

      - name: ðŸ“‹ Lint YAML Files
        run: |
          echo "ðŸ”§ Installing yamllint..."
          pip install yamllint
          echo "ðŸ“‹ Validating YAML files..."
          echo "ðŸ“ Checking templates (lenient rules)..."
          for yaml in templates/*.yml; do
            if [ -f "$yaml" ]; then
              yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}, \
                trailing-spaces: disable, new-line-at-end-of-file: disable, \
                comments: disable}}" "$yaml" && echo "âœ… $yaml valid" || \
                echo "âš ï¸ $yaml has warnings (non-blocking)"
            fi
          done
          echo "ðŸ”„ Checking other YAML files (strict rules)..."
          for yaml in .github/*.yml; do
            if [ -f "$yaml" ]; then
              yamllint -d relaxed "$yaml" || exit 1
              echo "âœ… $yaml syntax valid"
            fi
          done
          if [ -d "docs" ]; then
            echo "ðŸ“š Checking docs (lenient)..."
            for yaml in docs/*.yml; do
              if [ -f "$yaml" ]; then
                yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}, \
                  trailing-spaces: disable}}" "$yaml" && echo "âœ… $yaml valid" || \
                  echo "âš ï¸ $yaml has warnings"
              fi
            done
          fi
          echo "â„¹ï¸  Skipping workflow files validation (complex format)"

      - name: ðŸ”– Validate JSON Files
        run: |
          echo "ðŸ” Validating JSON files..."
          for json in templates/*.json examples/*.json .github/*.json; do
            if [ -f "$json" ]; then
              python3 -m json.tool "$json" > /dev/null || exit 1
              echo "âœ… $json syntax valid"
            fi
          done

      - name: ðŸ“š Check Documentation
        run: |
          echo "ðŸ“– Verifying required documentation files..."
          required_docs=(
            "README.md"
            "CHANGELOG.md"
            "SECURITY.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "LICENSE.txt"
          )
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Missing documentation: $doc"
              exit 1
            fi
            echo "âœ… $doc exists"
          done
          if [ -d "docs" ]; then
            echo "ðŸ“ Checking docs directory..."
            for doc in DEPLOYMENT.md BACKUP.md PERFORMANCE.md LEGAL.md MONITORING.md TOOLS.md; do
              if [ -f "docs/$doc" ]; then
                echo "âœ… docs/$doc exists"
              else
                echo "â„¹ï¸  docs/$doc missing (optional)"
              fi
            done
          fi

      - name: âœ… Lint Summary
        run: echo "ðŸŽ‰ All linting checks passed"

  build:
    name: ðŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Image (amd64 for testing)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          load: true
          tags: tor-relay:test
          pull: true
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            BUILD_VERSION=test-${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ’¾ Save Image for Testing
        run: |
          docker save tor-relay:test -o /tmp/tor-relay-test.tar
          echo "ðŸ“¦ Image size: $(du -h /tmp/tor-relay-test.tar | cut -f1)"

      - name: â¬†ï¸ Upload Image Artifact
        uses: actions/upload-artifact@v5
        with:
          name: docker-image
          path: /tmp/tor-relay-test.tar
          retention-days: 1

  integration:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: â¬‡ï¸ Download Docker Image
        uses: actions/download-artifact@v6
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: |
          docker load -i /tmp/tor-relay-test.tar
          docker image ls tor-relay

      - name: ðŸš€ Run Container Smoke Test
        run: |
          echo "ðŸš€ Starting container for smoke test..."
          docker run -d --name tor-test -e ENABLE_METRICS=true \
            -e ENABLE_HEALTH_CHECK=true tor-relay:test \
            /bin/sh -c "echo 'Test mode active'; sleep 60" || true
          sleep 5

      - name: ðŸ” Check Container Status
        run: |
          echo "ðŸ“Š Container status:"
          docker ps -a | grep tor-test || true
          echo ""
          echo "ðŸ“‹ Container logs:"
          docker logs tor-test 2>&1 | head -30 || true

      - name: ðŸ”§ Verify Tools Installation
        run: |
          echo "ðŸ” Checking installed tools..."
          docker run --rm tor-relay:test ls -la /usr/local/bin/ || exit 1
          echo ""
          echo "ðŸ› ï¸ Available diagnostic tools:"
          docker run --rm tor-relay:test sh -c "ls -1 /usr/local/bin/*.sh 2>/dev/null | \
            xargs -n1 basename | sort"

      - name: ðŸ§… Verify Tor Installation
        run: |
          echo "ðŸ” Checking Tor version..."
          TOR_VERSION=$(docker run --rm tor-relay:test tor --version | head -1)
          if [ -z "$TOR_VERSION" ]; then
            echo "âŒ Tor installation failed"
            exit 1
          fi
          echo "âœ… Tor installed: $TOR_VERSION"

      - name: ðŸ“ Verify File Structure
        run: |
          docker run --rm tor-relay:test sh -c "
            echo 'ðŸ“‚ === Directory Structure ===' && \
            ls -la / | grep -E 'var|etc|usr' && \
            echo '' && \
            echo 'ðŸ› ï¸ === Tools Directory ===' && \
            ls -la /usr/local/bin/ && \
            echo '' && \
            echo 'ðŸ’¾ === Data Directory ===' && \
            ls -la /var/lib/tor 2>/dev/null || echo '(data dir empty, expected)' && \
            echo '' && \
            echo 'ðŸ“ === Log Directory ===' && \
            ls -la /var/log/tor 2>/dev/null || echo '(log dir empty, expected)'
          "

      - name: ðŸ“‹ Check Build Metadata
        run: |
          echo "ðŸ” Checking build metadata..."
          docker run --rm tor-relay:test cat /build-info.txt || exit 1

      - name: ðŸ” Verify Permissions
        run: |
          echo "ðŸ” Verifying directory permissions..."
          docker run --rm tor-relay:test sh -c "
            ls -ld /var/lib/tor | grep -q '^d.*tor tor' && \
              echo 'âœ… /var/lib/tor permissions correct' || exit 1
            ls -ld /var/log/tor | grep -q '^d.*tor tor' && \
              echo 'âœ… /var/log/tor permissions correct' || exit 1
          "

      - name: âœ… Integration Tests Summary
        run: echo "ðŸŽ‰ Integration tests completed successfully"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker stop tor-test 2>/dev/null || true
          docker rm tor-test 2>/dev/null || true

  security:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      security-events: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: â¬‡ï¸ Download Docker Image
        uses: actions/download-artifact@v6
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: ðŸ”’ Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tor-relay:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: â¬†ï¸ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: ðŸ“Š Trivy Vulnerability Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tor-relay:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: âœ… Security Scan Complete
        run: echo "ðŸŽ‰ Security scan completed"

  test-matrix:
    name: ðŸ§ª Test Matrix
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        test-case:
          - 'help-flags'
          - 'file-permissions'
          - 'alpine-compatibility'
          - 'tool-executability'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: â¬‡ï¸ Download Docker Image
        uses: actions/download-artifact@v6
        with:
          name: docker-image
          path: /tmp

      - name: ðŸ“¦ Load Docker Image
        run: docker load -i /tmp/tor-relay-test.tar

      - name: "ðŸ” Test: Help Flags"
        if: matrix.test-case == 'help-flags'
        run: |
          echo "ðŸ§ª Testing tool help flags..."
          for tool in health.sh metrics.sh status.sh fingerprint.sh view-logs.sh \
            net-check.sh setup.sh dashboard.sh; do
            TOOL_PATH="/usr/local/bin/$tool"
            if docker run --rm tor-relay:test sh -c "test -f $TOOL_PATH"; then
              echo "ðŸ” Testing $tool --help..."
              docker run --rm tor-relay:test $tool --help > /dev/null && \
                echo "âœ… $tool --help works" || \
                echo "âš ï¸ $tool --help failed (non-critical)"
            else
              echo "âš ï¸  $tool not found at $TOOL_PATH"
            fi
          done

      - name: "ðŸ” Test: File Permissions"
        if: matrix.test-case == 'file-permissions'
        run: |
          echo "ðŸ” Verifying file permissions for .sh tools..."
          docker run --rm tor-relay:test sh -c "
            for tool in /usr/local/bin/*.sh; do
              if [ -f \"\$tool\" ]; then
                test -x \"\$tool\" && echo \"âœ… \$(basename \$tool) is executable\" || exit 1
              fi
            done
          "
          docker run --rm tor-relay:test sh -c "
            test -x /usr/local/bin/docker-entrypoint.sh && \
              echo 'âœ… docker-entrypoint.sh is executable' || exit 1
          "

      - name: "ðŸ”ï¸ Test: Alpine Compatibility"
        if: matrix.test-case == 'alpine-compatibility'
        run: |
          echo "ðŸ”ï¸ Verifying Alpine base image..."
          docker run --rm tor-relay:test sh -c "
            cat /etc/os-release | grep -i alpine && \
              echo 'âœ… Alpine base confirmed' || exit 1
            test -x /bin/sh && echo 'âœ… /bin/sh available' || exit 1
            apk --version > /dev/null 2>&1 && echo 'âœ… apk available' || exit 1
            command -v tor > /dev/null 2>&1 && echo 'âœ… tor available' || exit 1
          "

      - name: "ðŸ”§ Test: Tool Executability"
        if: matrix.test-case == 'tool-executability'
        run: |
          echo "ðŸ”§ Testing tool execution..."
          docker run --rm tor-relay:test sh -c "
            for tool in /usr/local/bin/*.sh; do
              if [ -f \"\$tool\" ]; then
                BASENAME=\$(basename \"\$tool\")
                echo \"ðŸ” Testing \$BASENAME...\"
                \"\$tool\" --help > /dev/null 2>&1 || \
                  echo \"  âš ï¸  \$BASENAME --help failed (may require Tor process)\"
              fi
            done
          "

  summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [lint, build, integration, security, test-matrix]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§… Build and Validation Pipeline

          ## ðŸ“Š Pipeline Status
          - **ðŸ” Lint:** \`${{ needs.lint.result }}\`
          - **ðŸ—ï¸ Build:** \`${{ needs.build.result }}\`
          - **ðŸ§ª Integration:** \`${{ needs.integration.result }}\`
          - **ðŸ›¡ï¸ Security:** \`${{ needs.security.result }}\`
          - **ðŸ§ª Test Matrix:** \`${{ needs.test-matrix.result }}\`

          ## ðŸ“¦ Build Information
          - **ðŸŒ¿ Branch:** \`${{ github.ref }}\`
          - **ðŸ“ Commit:** \`${{ github.sha }}\`
          - **ðŸ”¢ Run Number:** \`${{ github.run_number }}\`
          - **ðŸ“… Date:** \`$(date -u +'%Y-%m-%dT%H:%M:%SZ')\`

          ## âœ… Checks Performed
          - ðŸ³ Dockerfile validation with Hadolint
          - ðŸ“ Shell script syntax checking (all .sh files)
          - ðŸŽ¯ Shell script extension verification
          - ðŸ”Ž ShellCheck static analysis
          - ðŸ“‹ YAML validation (lenient for templates)
          - ðŸ”– JSON validation
          - ðŸ“š Documentation verification
          - ðŸ—ï¸ Docker image build (multi-arch ready)
          - ðŸš€ Container smoke test
          - ðŸ§… Tor installation verification
          - ðŸ”§ Tool availability check (.sh files)
          - ðŸ” Permission verification
          - ðŸ›¡ï¸ Security scanning with Trivy
          - ðŸ§ª Test matrix execution

          ## ðŸš€ Next Steps
          If all checks pass:
          - âœ… Image is ready for production use
          - ðŸ“¦ Release workflow will handle publishing to GHCR and Docker Hub
          - ðŸ·ï¸ Tag with semantic version to trigger release
          EOF

      - name: âœ… Build Pipeline Complete
        if: success()
        run: echo "ðŸŽ‰ All build and validation checks passed successfully"

      - name: âŒ Build Pipeline Failed
        if: failure()
        run: |
          echo "âŒ Build pipeline failed - check logs above for details"
          exit 1

