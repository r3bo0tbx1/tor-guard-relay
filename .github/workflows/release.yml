name: ğŸš€âœ¨ Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
  schedule:
    - cron: '30 18 * * 0'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

env:
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE_NAME: ${{ github.repository_owner }}/onion-relay
  DOCKERHUB_IMAGE_NAME: r3bo0tbx1/onion-relay

jobs:
  determine-version:
    name: ğŸ·ï¸ Determine Version and Build Type
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_type: ${{ steps.version.outputs.build_type }}
      is_release: ${{ steps.version.outputs.is_release }}
      build_date: ${{ steps.version.outputs.build_date }}
      short_sha: ${{ steps.version.outputs.short_sha }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Version and Build Type
        id: version
        run: |
          set -e
          echo "ğŸ” Determining version context..."
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            BUILD_TYPE="release"
            IS_RELEASE="true"
            echo "ğŸ·ï¸ Release tag detected: v${VERSION}"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
            VERSION="${LATEST_TAG#v}-manual-${GITHUB_RUN_NUMBER}"
            BUILD_TYPE="manual"
            IS_RELEASE="false"
            echo "ğŸ‘¤ Manual build version: ${VERSION}"
          else
            # Weekly rebuild: Use the last release version (no suffix)
            # This rebuilds the image with updated Alpine packages
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
            VERSION="${LATEST_TAG#v}"
            BUILD_TYPE="weekly"
            IS_RELEASE="false"
            echo "ğŸ“… Weekly rebuild of last release: ${VERSION} (with updated packages)"
          fi
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "build_type=${BUILD_TYPE}" >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‹ Version Information
        run: |
          echo "ğŸ“¦ Build Info:"
          echo "  ğŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
          echo "  ğŸ“ Build Type: ${{ steps.version.outputs.build_type }}"
          echo "  âœ… Release: ${{ steps.version.outputs.is_release }}"
          echo "  ğŸ“… Date: ${{ steps.version.outputs.build_date }}"
          echo "  ğŸ”‘ SHA: ${{ steps.version.outputs.short_sha }}"

  build-and-push:
    name: ğŸ—ï¸ Multi-Arch Build and Push
    runs-on: ubuntu-latest
    needs: determine-version
    permissions:
      contents: read
      packages: write
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ¯ Verify Tools Directory
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Pre-Build: Verifying Tools"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if [ ! -d "tools" ]; then
            echo "âŒ tools/ directory not found"
            exit 1
          fi

          TOOL_COUNT=0

          for file in tools/*; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")

            if head -1 "$file" 2>/dev/null | grep -q "^#!/bin/sh"; then
              echo "âœ… $filename (busybox sh)"
              TOOL_COUNT=$((TOOL_COUNT + 1))
            fi
          done

          echo ""
          if [ $TOOL_COUNT -lt 1 ]; then
            echo "âŒ Build blocked: No tools found in tools/"
            exit 1
          else
            echo "ğŸ‰ Found $TOOL_COUNT diagnostic tools (busybox-only, no .sh extension)"
          fi

      - name: ğŸ”§ Normalize scripts before build
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Normalizing Line Endings and Permissions"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          sudo apt-get update -qq && sudo apt-get install -y dos2unix

          echo "ğŸ“„ Processing main scripts..."
          for script in docker-entrypoint.sh healthcheck.sh Dockerfile; do
            if [ -f "$script" ]; then
              dos2unix "$script" 2>/dev/null || true
              echo "   âœ… Normalized: $script"
            fi
          done

          echo ""
          echo "ğŸ“ Processing tools/*..."
          if [ -d "tools" ]; then
            find tools -type f -exec dos2unix {} \; 2>/dev/null || true
            TOOL_COUNT=$(find tools -type f | wc -l)
            echo "   âœ… Normalized: $TOOL_COUNT tool scripts"
          fi

          echo ""
          echo "ğŸ” Setting execute permissions..."
          chmod +x docker-entrypoint.sh healthcheck.sh 2>/dev/null || true
          [ -d "tools" ] && chmod +x tools/* 2>/dev/null || true

          echo "   âœ… Permissions verified"
          echo ""
          echo "ğŸ‰ Normalization complete"

      - name: ğŸ³ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¦ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: ğŸ”¨ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Generate Docker Tags
        id: tags
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          BUILD_TYPE="${{ needs.determine-version.outputs.build_type }}"
          SHORT_SHA="${{ needs.determine-version.outputs.short_sha }}"

          TAGS=()

          if [ "$BUILD_TYPE" = "release" ]; then
            # New release: Update both :latest and version tags
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:latest")
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${VERSION}")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:latest")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:${VERSION}")
          elif [ "$BUILD_TYPE" = "weekly" ]; then
            # Weekly rebuild: Update version tag with fresh packages, keep :latest pointing to last release
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${VERSION}")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:${VERSION}")
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:latest")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:latest")
          elif [ "$BUILD_TYPE" = "validated" ]; then
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${VERSION}-validated")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:${VERSION}-validated")
          else
            # Manual builds: version tag only
            TAGS+=("${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${VERSION}")
            TAGS+=("${{ env.DOCKERHUB_IMAGE_NAME }}:${VERSION}")
          fi

          TAGS_STR=$(IFS=','; echo "${TAGS[*]}")
          echo "tags=${TAGS_STR}" >> "$GITHUB_OUTPUT"

      - name: ğŸš€ Build and Push Multi-Arch Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            BUILD_DATE=${{ needs.determine-version.outputs.build_date }}
            BUILD_VERSION=${{ needs.determine-version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=Tor Guard Relay
            org.opencontainers.image.description=Hardened Tor Guard Relay
            org.opencontainers.image.version=${{ needs.determine-version.outputs.version }}
            org.opencontainers.image.created=${{ needs.determine-version.outputs.build_date }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          sbom: true
          provenance: true

      - name: ğŸ“‹ Generate SBOM (CycloneDX & SPDX)
        if: needs.determine-version.outputs.is_release == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Generating Software Bill of Materials (SBOM)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Install syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          VERSION="${{ needs.determine-version.outputs.version }}"
          IMAGE="${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${VERSION}"

          echo "ğŸ“¦ Generating SBOM for image: ${IMAGE}"
          echo ""

          # Generate CycloneDX JSON
          echo "ğŸ“„ Generating CycloneDX JSON format..."
          syft "${IMAGE}" -o cyclonedx-json > "sbom-cyclonedx-v${VERSION}.json"
          echo "   âœ… sbom-cyclonedx-v${VERSION}.json"

          # Generate CycloneDX XML
          echo "ğŸ“„ Generating CycloneDX XML format..."
          syft "${IMAGE}" -o cyclonedx-xml > "sbom-cyclonedx-v${VERSION}.xml"
          echo "   âœ… sbom-cyclonedx-v${VERSION}.xml"

          # Generate SPDX JSON
          echo "ğŸ“„ Generating SPDX JSON format..."
          syft "${IMAGE}" -o spdx-json > "sbom-spdx-v${VERSION}.json"
          echo "   âœ… sbom-spdx-v${VERSION}.json"

          # Generate SPDX tag-value
          echo "ğŸ“„ Generating SPDX tag-value format..."
          syft "${IMAGE}" -o spdx-tag-value > "sbom-spdx-v${VERSION}.spdx"
          echo "   âœ… sbom-spdx-v${VERSION}.spdx"

          # Generate human-readable table
          echo "ğŸ“„ Generating human-readable table..."
          syft "${IMAGE}" -o table > "sbom-table-v${VERSION}.txt"
          echo "   âœ… sbom-table-v${VERSION}.txt"

          echo ""
          echo "âœ… SBOM generation complete"
          echo ""
          echo "ğŸ“Š Package Statistics:"
          jq '.components | length' "sbom-cyclonedx-v${VERSION}.json" | xargs echo "   Total packages:"

      - name: ğŸ“¤ Upload SBOM Artifacts
        if: needs.determine-version.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-v${{ needs.determine-version.outputs.version }}
          path: |
            sbom-*.json
            sbom-*.xml
            sbom-*.spdx
            sbom-*.txt
          retention-days: 90

  release-notes:
    name: ğŸ“ Generate Release Notes
    runs-on: ubuntu-latest
    needs: [determine-version, build-and-push]
    permissions:
      contents: write
    if: needs.determine-version.outputs.is_release == 'true'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ“ Generate Notes
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          GHCR_IMAGE="${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}"
          DOCKERHUB_IMAGE="${{ env.DOCKERHUB_IMAGE_NAME }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generating Release Notes for v${VERSION}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Try to extract from CHANGELOG.md first
          CHANGELOG_FOUND=0

          if [ -f CHANGELOG.md ]; then
            echo "ğŸ” Checking CHANGELOG.md for v${VERSION}..."

            awk -v version="${VERSION}" '
              $0 ~ "^##[[:space:]]*(\\[v?" version "\\]|v" version ")([[:space:]]*-.*)?$" {p=1; next}
              p && /^##[[:space:]]*\[/ && !($0 ~ version) {p=0}
              p
            ' CHANGELOG.md > tmp_notes.txt

            sed -i '/^$/N;/^\n$/D' tmp_notes.txt 2>/dev/null || true

            if [ -s tmp_notes.txt ]; then
              echo "âœ… Found changelog section for v${VERSION} in CHANGELOG.md"
              CHANGELOG_FOUND=1

              echo "## ğŸ§… Tor Guard Relay v${VERSION}" > release_notes.md
              echo "" >> release_notes.md
              cat tmp_notes.txt >> release_notes.md
            else
              echo "âš ï¸ No changelog section found for v${VERSION} in CHANGELOG.md"
            fi
          else
            echo "âš ï¸ CHANGELOG.md not found"
          fi

          # Fall back to auto-generated notes from commits
          if [ "$CHANGELOG_FOUND" = "0" ]; then
            echo "ğŸ“‹ Auto-generating release notes from commits..."

            if [ -x scripts/release/generate-release-notes.sh ]; then
              # Use auto-generation script
              chmod +x scripts/release/generate-release-notes.sh
              ./scripts/release/generate-release-notes.sh --format github "${VERSION}" > release_notes.md
              echo "âœ… Auto-generated release notes from conventional commits"
            else
              # Simple fallback
              echo "## ğŸ§… Tor Guard Relay v${VERSION}" > release_notes.md
              echo "" >> release_notes.md
              echo "### Changes" >> release_notes.md
              echo "" >> release_notes.md
              git log --pretty=format:"- %s (\`%h\`) by %an" "$(git describe --tags --abbrev=0)..HEAD" >> release_notes.md || echo "- Initial release" >> release_notes.md
              echo "" >> release_notes.md
              echo "âš ï¸ **Note:** Release notes were auto-generated from commit history." >> release_notes.md
              echo "For detailed changes, see the commit history below." >> release_notes.md
              echo "âœ… Generated basic release notes from commit history"
            fi
          fi

          # Append Docker images and SBOM info
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ğŸ³ Docker Images" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# From GitHub Container Registry (GHCR)" >> release_notes.md
          echo "docker pull ${GHCR_IMAGE}:${VERSION}" >> release_notes.md
          echo "" >> release_notes.md
          echo "# From Docker Hub" >> release_notes.md
          echo "docker pull ${DOCKERHUB_IMAGE}:${VERSION}" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ğŸ“‹ Software Bill of Materials (SBOM)" >> release_notes.md
          echo "" >> release_notes.md
          echo "This release includes comprehensive SBOM files for supply chain security:" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **CycloneDX**: JSON and XML formats" >> release_notes.md
          echo "- **SPDX**: JSON and tag-value formats" >> release_notes.md
          echo "- **Human-readable**: Table format" >> release_notes.md
          echo "" >> release_notes.md
          echo "Download SBOM files from the release assets below." >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 2>/dev/null || echo 'v1.0.0')...v${VERSION}" >> release_notes.md

          echo ""
          echo "âœ… Release notes generation complete"

      - name: ğŸ“¦ Download SBOM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-v${{ needs.determine-version.outputs.version }}
          path: ./sbom

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.determine-version.outputs.version }}
          name: "ğŸ§… Tor Guard Relay v${{ needs.determine-version.outputs.version }}"
          body_path: release_notes.md
          files: |
            sbom/*.json
            sbom/*.xml
            sbom/*.spdx
            sbom/*.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
