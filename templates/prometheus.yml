# prometheus.yml - Tor Guard Relay Multi-Relay Monitoring Configuration
# Scrapes metrics from multiple relay instances and routes alerts

global:
  scrape_interval: 15s           # How often to scrape targets
  evaluation_interval: 15s       # How often to evaluate alert rules
  external_labels:
    monitor: 'tor-relay-monitor'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - localhost:9093

# Load alert rules
rule_files:
  - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # ============================================================================
  # Prometheus self-monitoring
  # ============================================================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 30s

  # ============================================================================
  # Alertmanager self-monitoring
  # ============================================================================
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['localhost:9093']
    scrape_interval: 30s

  # ============================================================================
  # TOR RELAY METRICS (Multi-Relay Setup)
  # ============================================================================
  
  # Relay 1 - Guard relay on port 9035
  - job_name: 'tor-relay-1'
    static_configs:
      - targets: ['localhost:9035']
        labels:
          relay_id: '1'
          relay_type: 'guard'
    scrape_interval: 30s
    metrics_path: '/metrics'
    honor_timestamps: true
    scrape_timeout: 15s
    scheme: http

  # Relay 2 - Guard relay on port 9036
  - job_name: 'tor-relay-2'
    static_configs:
      - targets: ['localhost:9036']
        labels:
          relay_id: '2'
          relay_type: 'guard'
    scrape_interval: 30s
    metrics_path: '/metrics'
    honor_timestamps: true
    scrape_timeout: 15s
    scheme: http

  # Relay 3 - Guard relay on port 9037
  - job_name: 'tor-relay-3'
    static_configs:
      - targets: ['localhost:9037']
        labels:
          relay_id: '3'
          relay_type: 'guard'
    scrape_interval: 30s
    metrics_path: '/metrics'
    honor_timestamps: true
    scrape_timeout: 15s
    scheme: http

  # ============================================================================
  # OPTIONAL: Add more relays here (ports 9038+)
  # ============================================================================
  # Uncomment and duplicate the above section for additional relays
  #
  # - job_name: 'tor-relay-4'
  #   static_configs:
  #     - targets: ['localhost:9038']
  #       labels:
  #         relay_id: '4'
  #         relay_type: 'guard'
  #   scrape_interval: 30s
  #
  # - job_name: 'tor-relay-5'
  #   static_configs:
  #     - targets: ['localhost:9039']
  #       labels:
  #         relay_id: '5'
  #         relay_type: 'guard'
  #   scrape_interval: 30s

  # ============================================================================
  # OPTIONAL: System metrics (if node-exporter is running)
  # ============================================================================
  # - job_name: 'node'
  #   static_configs:
  #     - targets: ['localhost:9100']
  #   scrape_interval: 30s

---

# Alert Rules (save as /etc/prometheus/rules/tor-relay-alerts.yml)
#
# groups:
#   - name: tor_relay_alerts
#     interval: 30s
#     rules:
#       # Bootstrap alert
#       - alert: TorBootstrapIncomplete
#         expr: tor_relay_bootstrap_percent < 100
#         for: 5m
#         labels:
#           severity: warning
#           alert_type: bootstrap
#         annotations:
#           summary: "Relay {{ $labels.relay_name }} bootstrap incomplete"
#           description: "Bootstrap: {{ $value }}%"
#
#       # ORPort unreachable
#       - alert: TorORPortUnreachable
#         expr: tor_relay_or_port_reachable == 0
#         for: 10m
#         labels:
#           severity: critical
#           alert_type: reachability
#         annotations:
#           summary: "Relay {{ $labels.relay_name }} ORPort unreachable"
#           description: "ORPort {{ $labels.port }} is not reachable"
#
#       # High CPU usage
#       - alert: TorRelayHighCPU
#         expr: rate(process_cpu_seconds_total[5m]) > 0.8
#         for: 15m
#         labels:
#           severity: high
#           alert_type: performance
#         annotations:
#           summary: "Relay {{ $labels.relay_name }} high CPU"
#           description: "CPU usage: {{ $value | humanizePercentage }}"
#
#       # High memory usage
#       - alert: TorRelayHighMemory
#         expr: process_resident_memory_bytes / 1024 / 1024 > 512
#         for: 10m
#         labels:
#           severity: warning
#           alert_type: performance
#         annotations:
#           summary: "Relay {{ $labels.relay_name }} high memory"
#           description: "Memory: {{ $value | humanize }}MB"

---

# USAGE:
#
# 1. Place this file at: /opt/tor-relay/prometheus.yml
#
# 2. With Docker Compose:
#    docker-compose up -d prometheus
#
# 3. With Cosmos Cloud:
#    Upload via Cosmos UI
#
# 4. Access Prometheus:
#    http://localhost:9090
#
# 5. Query metrics:
#    - http://localhost:9090/graph
#    - Metrics: tor_relay_bootstrap_percent, tor_relay_uptime_seconds, etc.
#
# 6. Verify scrape targets:
#    http://localhost:9090/targets
#
# 7. Add more relays:
#    - Update relay_id, relay_type labels
#    - Ensure unique ports (9035, 9036, 9037, ...)
#    - Each relay must expose metrics on its port

---

# ============================================================================
# REFERENCE: Available Tor Relay Metrics
# ============================================================================
#
# tor_relay_bootstrap_percent           - Bootstrap progress (0-100)
# tor_relay_uptime_seconds              - Relay uptime in seconds
# tor_relay_or_port_reachable           - ORPort reachability (0/1)
# tor_relay_exit_relay_enabled          - Exit relay status (0/1)
# tor_relay_bridge_relay_enabled        - Bridge relay status (0/1)
# tor_relay_bandwidth_rate_mbps         - Configured rate limit
# tor_relay_bandwidth_burst_mbps        - Configured burst limit
# tor_relay_connections                 - Active connections
# tor_relay_metrics_timestamp_ns        - Metrics collection timestamp
#
# ============================================================================