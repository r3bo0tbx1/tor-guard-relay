#!/bin/sh
# metrics-http - HTTP server for Prometheus metrics endpoint
# Usage: metrics-http [--port PORT] [--help]

set -e

# Configuration
VERSION="1.1.0"
METRICS_PORT="${METRICS_PORT:-9052}"
METRICS_BIND="${METRICS_BIND:-0.0.0.0}"
METRICS_PATH="${METRICS_PATH:-/metrics}"
ENABLE_METRICS="${ENABLE_METRICS:-true}"
RESPONSE_TIMEOUT="${RESPONSE_TIMEOUT:-10}"

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    --help|-h)
      cat << EOF
üåê Tor-Guard-Relay Metrics HTTP Server v${VERSION}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

USAGE:
    metrics-http [OPTIONS]

OPTIONS:
    --port PORT     Listen port (default: 9052)
    --bind ADDR     Bind address (default: 0.0.0.0)
    --path PATH     Metrics path (default: /metrics)
    --daemon        Run as daemon
    --help, -h      Show this help message

ENVIRONMENT VARIABLES:
    METRICS_PORT         Port to listen on (default: 9052)
    METRICS_BIND         Address to bind (default: 0.0.0.0)
    METRICS_PATH         URL path for metrics (default: /metrics)
    ENABLE_METRICS       Enable metrics server (true/false)
    RESPONSE_TIMEOUT     Response timeout in seconds

ENDPOINTS:
    http://localhost:9052/metrics    Prometheus metrics
    http://localhost:9052/health     Health check endpoint
    http://localhost:9052/           Status page

PROMETHEUS CONFIG:
    scrape_configs:
      - job_name: 'tor-relay'
        static_configs:
          - targets: ['relay:9052']
        metrics_path: '/metrics'
        scrape_interval: 30s

DOCKER INTEGRATION:
    # Expose in docker-compose.yml
    ports:
      - "9052:9052"

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF
      exit 0
      ;;
    --port)
      shift
      METRICS_PORT="$1"
      shift
      ;;
    --bind)
      shift
      METRICS_BIND="$1"
      shift
      ;;
    --path)
      shift
      METRICS_PATH="$1"
      shift
      ;;
    --daemon)
      DAEMON_MODE="true"
      ;;
    -*) 
      echo "‚ùå Unknown option: $arg"
      echo "üí° Use --help for usage information"
      exit 2
      ;;
  esac
done

# Check if metrics are enabled
if [ "$ENABLE_METRICS" != "true" ]; then
  echo "üìä Metrics HTTP server is disabled"
  echo "üí° Set ENABLE_METRICS=true to enable"
  exit 0
fi

# Check for netcat
if ! command -v nc > /dev/null 2>&1; then
  echo "‚ùå Error: netcat (nc) is required but not installed"
  echo "üí° Install with: apk add netcat-openbsd"
  exit 1
fi

# Function to generate HTTP response
generate_response() {
  REQUEST_PATH="$1"
  
  case "$REQUEST_PATH" in
    "$METRICS_PATH")
      # Generate metrics
      METRICS_OUTPUT=$(/usr/local/bin/metrics 2>/dev/null || echo "# Error generating metrics")
      CONTENT_LENGTH=$(echo -n "$METRICS_OUTPUT" | wc -c)
      
      cat << EOF
HTTP/1.1 200 OK
Content-Type: text/plain; version=0.0.4
Content-Length: $CONTENT_LENGTH
Cache-Control: no-cache
Connection: close

$METRICS_OUTPUT
EOF
      ;;
      
    "/health")
      # Health check endpoint
      HEALTH_JSON=$(/usr/local/bin/health --json 2>/dev/null || echo '{"status":"error"}')
      CONTENT_LENGTH=$(echo -n "$HEALTH_JSON" | wc -c)
      
      cat << EOF
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: $CONTENT_LENGTH
Cache-Control: no-cache
Connection: close

$HEALTH_JSON
EOF
      ;;
      
    "/")
      # Status page
      HTML_CONTENT="<!DOCTYPE html>
<html>
<head>
    <title>Tor Relay Metrics</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background: #f5f5f5; }
        h1 { color: #7d4698; }
        .status { padding: 20px; background: white; border-radius: 8px; margin: 20px 0; }
        .endpoint { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        a { color: #7d4698; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .ok { color: green; }
        .loading { color: orange; }
    </style>
</head>
<body>
    <h1>üßÖ Tor Relay Metrics Server</h1>
    <div class=\"status\">
        <h2>Available Endpoints:</h2>
        <div class=\"endpoint\">
            üìä <a href=\"$METRICS_PATH\">$METRICS_PATH</a> - Prometheus metrics
        </div>
        <div class=\"endpoint\">
            üíö <a href=\"/health\">/health</a> - Health check (JSON)
        </div>
        <div class=\"endpoint\">
            üè† <a href=\"/\">/</a> - This status page
        </div>
    </div>
    <div class=\"status\">
        <h2>Configuration:</h2>
        <p>Port: $METRICS_PORT</p>
        <p>Bind: $METRICS_BIND</p>
        <p>Version: $VERSION</p>
    </div>
</body>
</html>"
      
      CONTENT_LENGTH=$(echo -n "$HTML_CONTENT" | wc -c)
      
      cat << EOF
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: $CONTENT_LENGTH
Cache-Control: no-cache
Connection: close

$HTML_CONTENT
EOF
      ;;
      
    *)
      # 404 Not Found
      ERROR_MSG="404 - Not Found"
      CONTENT_LENGTH=$(echo -n "$ERROR_MSG" | wc -c)
      
      cat << EOF
HTTP/1.1 404 Not Found
Content-Type: text/plain
Content-Length: $CONTENT_LENGTH
Connection: close

$ERROR_MSG
EOF
      ;;
  esac
}

# Signal handler for clean shutdown
cleanup() {
  echo ""
  echo "üõë Shutting down metrics HTTP server..."
  exit 0
}

trap cleanup INT TERM

# Start server
echo "üìä Starting Tor Relay Metrics HTTP Server v${VERSION}"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üåê Listening on: http://$METRICS_BIND:$METRICS_PORT"
echo "üìç Metrics path: $METRICS_PATH"
echo "üí° Press Ctrl+C to stop"
echo ""

# Main server loop
if [ "$DAEMON_MODE" = "true" ]; then
  # Run in background
  while true; do
    echo -e "$(generate_response "$METRICS_PATH")" | nc -l -p "$METRICS_PORT" -w "$RESPONSE_TIMEOUT" > /dev/null 2>&1 &
    wait
  done &
  echo "‚úÖ Server running in daemon mode (PID: $!)"
else
  # Run in foreground
  while true; do
    # Wait for connection and parse request
    REQUEST=$(echo -e "HTTP/1.1 200 OK\r\n\r\n" | nc -l -p "$METRICS_PORT" -w "$RESPONSE_TIMEOUT" 2>/dev/null | head -1)
    
    if [ -n "$REQUEST" ]; then
      # Extract path from request
      REQUEST_PATH=$(echo "$REQUEST" | awk '{print $2}')
      
      # Log request
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] $REQUEST"
      
      # Generate and send response
      generate_response "$REQUEST_PATH" | nc -l -p "$METRICS_PORT" -w 1 > /dev/null 2>&1 &
    fi
  done
fi