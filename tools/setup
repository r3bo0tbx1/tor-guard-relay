#!/bin/sh
# setup - Interactive configuration wizard for Tor relay
# Usage: setup [--auto|--help]

set -e

# Configuration
VERSION="1.1.0"
CONFIG_FILE="${CONFIG_FILE:-/etc/tor/torrc}"
RELAY_TYPE="${RELAY_TYPE:-guard}"
AUTO_MODE="${AUTO_MODE:-false}"
DEFAULT_NICKNAME="${DEFAULT_NICKNAME:-MyTorRelay}"
DEFAULT_CONTACT="${DEFAULT_CONTACT:-admin@example.com}"
DEFAULT_ORPORT="${DEFAULT_ORPORT:-9001}"
DEFAULT_DIRPORT="${DEFAULT_DIRPORT:-9030}"
DEFAULT_BANDWIDTH="${DEFAULT_BANDWIDTH:-1024}"

# Colors for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    --help|-h)
      cat << EOF
ðŸ§™ Tor-Guard-Relay Setup Wizard v${VERSION}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

USAGE:
    setup [OPTIONS]

OPTIONS:
    --auto          Use defaults for all prompts
    --config FILE   Config file path (default: /etc/tor/torrc)
    --type TYPE     Relay type: guard|exit|bridge
    --help, -h      Show this help message

ENVIRONMENT VARIABLES:
    CONFIG_FILE         Path to torrc file
    RELAY_TYPE          Type of relay (guard/exit/bridge)
    DEFAULT_NICKNAME    Default nickname
    DEFAULT_CONTACT     Default contact info
    DEFAULT_ORPORT      Default ORPort
    DEFAULT_DIRPORT     Default DirPort
    DEFAULT_BANDWIDTH   Default bandwidth in KB/s
    AUTO_MODE          Skip prompts and use defaults

RELAY TYPES:
    guard    Middle/Guard relay (recommended for beginners)
    exit     Exit relay (requires careful consideration)
    bridge   Bridge relay (helps censored users)

WIZARD STEPS:
    1. Relay nickname selection
    2. Contact information
    3. Port configuration (ORPort/DirPort)
    4. Bandwidth limits
    5. Relay type selection
    6. Configuration validation

EXAMPLES:
    setup                    # Interactive wizard
    setup --auto            # Auto-configure with defaults
    setup --type bridge     # Configure as bridge relay

OUTPUT:
    Creates a complete torrc configuration file ready
    for production use with all required settings.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF
      exit 0
      ;;
    --auto) AUTO_MODE="true" ;;
    --config)
      shift
      CONFIG_FILE="$1"
      shift
      ;;
    --type)
      shift
      RELAY_TYPE="$1"
      shift
      ;;
    -*) 
      echo "âŒ Unknown option: $arg"
      echo "ðŸ’¡ Use --help for usage information"
      exit 2
      ;;
  esac
done

# Helper functions
print_header() {
  echo ""
  echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

print_step() {
  echo -e "${GREEN}[$1/6]${NC} $2"
}

validate_nickname() {
  echo "$1" | grep -qE "^[a-zA-Z0-9]{1,19}$"
}

validate_email() {
  echo "$1" | grep -qE "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
}

validate_port() {
  [ "$1" -ge 1 ] && [ "$1" -le 65535 ] 2>/dev/null
}

validate_bandwidth() {
  [ "$1" -ge 256 ] 2>/dev/null
}

# Main setup wizard
clear
cat << EOF
${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘          ðŸ§… Tor-Guard-Relay Setup Wizard v${VERSION}          â•‘
â•‘                                                            â•‘
â•‘            Configure your Tor relay in 6 steps            â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}

This wizard will help you configure a Tor relay with optimal
settings for your network and preferences.

Press Ctrl+C at any time to cancel.
EOF

# Step 1: Nickname
print_header "Step 1: Relay Nickname"
print_step "1" "Choose a nickname for your relay"
echo ""
echo "Requirements:"
echo "  â€¢ 1-19 characters"
echo "  â€¢ Only letters and numbers"
echo "  â€¢ No spaces or special characters"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  NICKNAME="$DEFAULT_NICKNAME"
  echo -e "${GREEN}âœ“${NC} Using default: $NICKNAME"
else
  while true; do
    printf "Enter nickname [${DEFAULT_NICKNAME}]: "
    read NICKNAME
    [ -z "$NICKNAME" ] && NICKNAME="$DEFAULT_NICKNAME"
    
    if validate_nickname "$NICKNAME"; then
      echo -e "${GREEN}âœ“${NC} Nickname accepted: $NICKNAME"
      break
    else
      echo -e "${RED}âœ—${NC} Invalid nickname. Please try again."
    fi
  done
fi

# Step 2: Contact Info
print_header "Step 2: Contact Information"
print_step "2" "Provide contact information (public)"
echo ""
echo "This helps the Tor Project contact you if needed."
echo "Use an email address you're comfortable making public."
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  CONTACT="$DEFAULT_CONTACT"
  echo -e "${GREEN}âœ“${NC} Using default: $CONTACT"
else
  while true; do
    printf "Enter email [${DEFAULT_CONTACT}]: "
    read CONTACT
    [ -z "$CONTACT" ] && CONTACT="$DEFAULT_CONTACT"
    
    if validate_email "$CONTACT"; then
      echo -e "${GREEN}âœ“${NC} Contact accepted: $CONTACT"
      break
    else
      echo -e "${YELLOW}âš ${NC} Invalid email format, but continuing..."
      break
    fi
  done
fi

# Step 3: Port Configuration
print_header "Step 3: Port Configuration"
print_step "3" "Configure network ports"
echo ""
echo "ORPort: Main port for Tor traffic (must be accessible)"
echo "DirPort: Directory service port (optional)"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  ORPORT="$DEFAULT_ORPORT"
  DIRPORT="$DEFAULT_DIRPORT"
  echo -e "${GREEN}âœ“${NC} Using defaults: ORPort=$ORPORT, DirPort=$DIRPORT"
else
  while true; do
    printf "Enter ORPort [${DEFAULT_ORPORT}]: "
    read ORPORT
    [ -z "$ORPORT" ] && ORPORT="$DEFAULT_ORPORT"
    
    if validate_port "$ORPORT"; then
      echo -e "${GREEN}âœ“${NC} ORPort accepted: $ORPORT"
      break
    else
      echo -e "${RED}âœ—${NC} Invalid port (1-65535). Please try again."
    fi
  done
  
  while true; do
    printf "Enter DirPort [${DEFAULT_DIRPORT}]: "
    read DIRPORT
    [ -z "$DIRPORT" ] && DIRPORT="$DEFAULT_DIRPORT"
    
    if validate_port "$DIRPORT"; then
      echo -e "${GREEN}âœ“${NC} DirPort accepted: $DIRPORT"
      break
    else
      echo -e "${RED}âœ—${NC} Invalid port (1-65535). Please try again."
    fi
  done
fi

# Step 4: Bandwidth Limits
print_header "Step 4: Bandwidth Allocation"
print_step "4" "Set bandwidth limits (KB/s)"
echo ""
echo "Recommended minimums:"
echo "  â€¢ Guard relay: 1024 KB/s (1 MB/s)"
echo "  â€¢ Exit relay: 2048 KB/s (2 MB/s)"
echo "  â€¢ Bridge: 512 KB/s"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  BANDWIDTH="$DEFAULT_BANDWIDTH"
  echo -e "${GREEN}âœ“${NC} Using default: $BANDWIDTH KB/s"
else
  while true; do
    printf "Enter bandwidth limit in KB/s [${DEFAULT_BANDWIDTH}]: "
    read BANDWIDTH
    [ -z "$BANDWIDTH" ] && BANDWIDTH="$DEFAULT_BANDWIDTH"
    
    if validate_bandwidth "$BANDWIDTH"; then
      echo -e "${GREEN}âœ“${NC} Bandwidth accepted: $BANDWIDTH KB/s"
      break
    else
      echo -e "${RED}âœ—${NC} Minimum bandwidth is 256 KB/s. Please try again."
    fi
  done
fi

# Step 5: Relay Type
print_header "Step 5: Relay Type Selection"
print_step "5" "Choose relay type"
echo ""
echo "Available types:"
echo "  ${GREEN}guard${NC}  - Middle/Guard relay (recommended)"
echo "  ${YELLOW}exit${NC}   - Exit relay (requires careful consideration)"
echo "  ${BLUE}bridge${NC} - Bridge relay (helps censored users)"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  echo -e "${GREEN}âœ“${NC} Using default type: $RELAY_TYPE"
else
  printf "Enter relay type [guard/exit/bridge] [${RELAY_TYPE}]: "
  read TYPE_INPUT
  [ -n "$TYPE_INPUT" ] && RELAY_TYPE="$TYPE_INPUT"
  
  case "$RELAY_TYPE" in
    guard|exit|bridge)
      echo -e "${GREEN}âœ“${NC} Relay type: $RELAY_TYPE"
      ;;
    *)
      echo -e "${YELLOW}âš ${NC} Unknown type, defaulting to guard"
      RELAY_TYPE="guard"
      ;;
  esac
fi

# Step 6: Generate Configuration
print_header "Step 6: Generating Configuration"
print_step "6" "Creating torrc file"
echo ""

# Create configuration
cat > "$CONFIG_FILE" << EOF
# Tor Relay Configuration
# Generated by Tor-Guard-Relay Setup Wizard v${VERSION}
# Date: $(date '+%Y-%m-%d %H:%M:%S')

# Basic Information
Nickname $NICKNAME
ContactInfo $CONTACT

# Network Settings
ORPort $ORPORT
DirPort $DIRPORT

# Bandwidth Limits
RelayBandwidthRate $BANDWIDTH KB
RelayBandwidthBurst $((BANDWIDTH * 2)) KB

# Relay Type Configuration
EOF

case "$RELAY_TYPE" in
  exit)
    cat >> "$CONFIG_FILE" << EOF
ExitRelay 1
ExitPolicy accept *:80     # HTTP
ExitPolicy accept *:443    # HTTPS
ExitPolicy accept *:6667   # IRC
ExitPolicy accept *:22     # SSH
ExitPolicy reject *:*      # Reject everything else
EOF
    ;;
  bridge)
    cat >> "$CONFIG_FILE" << EOF
BridgeRelay 1
PublishServerDescriptor bridge
ExitRelay 0
EOF
    ;;
  *)
    cat >> "$CONFIG_FILE" << EOF
ExitRelay 0
ExitPolicy reject *:*
EOF
    ;;
esac

# Add common settings
cat >> "$CONFIG_FILE" << EOF

# Logging
Log notice file /var/log/tor/notices.log
Log notice syslog

# Data Directory
DataDirectory /var/lib/tor

# Performance
NumCPUs 0  # Use all available CPUs
HardwareAccel 1

# Security
NoExec 1
EOF

# Validate configuration
echo -e "${GREEN}âœ“${NC} Configuration generated successfully!"
echo ""
echo "ðŸ“‹ Configuration Summary:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Nickname:    $NICKNAME"
echo "  Contact:     $CONTACT"
echo "  ORPort:      $ORPORT"
echo "  DirPort:     $DIRPORT"
echo "  Bandwidth:   $BANDWIDTH KB/s"
echo "  Type:        $RELAY_TYPE"
echo "  Config:      $CONFIG_FILE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo -e "${GREEN}âœ… Setup complete!${NC}"
echo ""
echo "Next steps:"
echo "  1. Review the configuration: cat $CONFIG_FILE"
echo "  2. Start your relay: tor -f $CONFIG_FILE"
echo "  3. Monitor status: /usr/local/bin/status"
echo "  4. Check metrics: /usr/local/bin/metrics"
echo ""
echo "ðŸŒ Your relay will appear on Tor Metrics after ~3 hours:"
echo "   https://metrics.torproject.org/rs.html"