#!/bin/sh
# setup - Interactive configuration wizard for Tor relay
# Usage: setup [--auto|--help]

set -e

# Configuration
VERSION="1.1.1"
CONFIG_FILE="${CONFIG_FILE:-/etc/tor/torrc}"
RELAY_TYPE="${RELAY_TYPE:-guard}"
AUTO_MODE="${AUTO_MODE:-false}"
DEFAULT_NICKNAME="${DEFAULT_NICKNAME:-MyTorRelay}"
DEFAULT_CONTACT="${DEFAULT_CONTACT:-admin@example.com}"
DEFAULT_ORPORT="${DEFAULT_ORPORT:-9001}"
DEFAULT_DIRPORT="${DEFAULT_DIRPORT:-9030}"
DEFAULT_BANDWIDTH="${DEFAULT_BANDWIDTH:-1024}"
CREATE_BACKUP="${CREATE_BACKUP:-true}"  # üîí NEW: Backup control

# Colors for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Trap for clean exit
trap 'cleanup' INT TERM

cleanup() {
  echo ""
  echo -e "${YELLOW}Setup cancelled by user${NC}"
  exit 130
}

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    --help|-h)
      cat << EOF
üßô Tor-Guard-Relay Setup Wizard v${VERSION}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

USAGE:
    setup [OPTIONS]

OPTIONS:
    --auto          Use defaults for all prompts
    --config FILE   Config file path (default: /etc/tor/torrc)
    --type TYPE     Relay type: guard|exit|bridge
    --no-backup     Skip backup creation (not recommended)
    --help, -h      Show this help message

ENVIRONMENT VARIABLES:
    CONFIG_FILE         Path to torrc file
    RELAY_TYPE          Type of relay (guard/exit/bridge)
    DEFAULT_NICKNAME    Default nickname
    DEFAULT_CONTACT     Default contact info
    DEFAULT_ORPORT      Default ORPort
    DEFAULT_DIRPORT     Default DirPort
    DEFAULT_BANDWIDTH   Default bandwidth in KB/s
    AUTO_MODE          Skip prompts and use defaults
    CREATE_BACKUP      Create backup before overwriting (default: true)

RELAY TYPES:
    guard    Middle/Guard relay (recommended for beginners)
    exit     Exit relay (requires careful consideration)
    bridge   Bridge relay (helps censored users)

SAFETY FEATURES:
    üîí Automatic backup creation before overwriting existing config
    üîí Backup stored as: [config].backup.[timestamp]
    üîí Validation before writing
    üîí Safe cancellation with Ctrl+C

WIZARD STEPS:
    1. Relay nickname selection
    2. Contact information
    3. Port configuration (ORPort/DirPort)
    4. Bandwidth limits
    5. Relay type selection
    6. Configuration validation

EXAMPLES:
    setup                    # Interactive wizard
    setup --auto            # Auto-configure with defaults
    setup --type bridge     # Configure as bridge relay
    setup --no-backup       # Skip backup (not recommended)

OUTPUT:
    Creates a complete torrc configuration file ready
    for production use with all required settings.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF
      exit 0
      ;;
    --auto) AUTO_MODE="true" ;;
    --config)
      shift
      CONFIG_FILE="$1"
      shift
      ;;
    --type)
      shift
      RELAY_TYPE="$1"
      shift
      ;;
    --no-backup) CREATE_BACKUP="false" ;;
    -*) 
      echo "‚ùå Unknown option: $arg"
      echo "üí° Use --help for usage information"
      exit 2
      ;;
  esac
done

# Helper functions
print_header() {
  echo ""
  echo -e "${PURPLE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${PURPLE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
}

print_step() {
  echo -e "${GREEN}[$1/6]${NC} $2"
}

validate_nickname() {
  echo "$1" | grep -qE "^[a-zA-Z0-9]{1,19}$"
}

validate_email() {
  echo "$1" | grep -qE "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
}

validate_port() {
  [ "$1" -ge 1 ] && [ "$1" -le 65535 ] 2>/dev/null
}

validate_bandwidth() {
  [ "$1" -ge 256 ] 2>/dev/null
}

# üîí NEW: Backup function
create_config_backup() {
  if [ -f "$CONFIG_FILE" ] && [ "$CREATE_BACKUP" = "true" ]; then
    BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${CONFIG_FILE}.backup.${BACKUP_TIMESTAMP}"
    
    echo -e "${BLUE}üì¶ Creating backup...${NC}"
    
    if cp "$CONFIG_FILE" "$BACKUP_FILE" 2>/dev/null; then
      echo -e "${GREEN}‚úÖ Backup created: $BACKUP_FILE${NC}"
      
      # Keep only last 5 backups
      BACKUP_COUNT=$(ls -1 "${CONFIG_FILE}.backup."* 2>/dev/null | wc -l)
      if [ "$BACKUP_COUNT" -gt 5 ]; then
        echo -e "${YELLOW}üßπ Cleaning old backups (keeping last 5)...${NC}"
        ls -1t "${CONFIG_FILE}.backup."* | tail -n +6 | xargs rm -f 2>/dev/null || true
      fi
      
      return 0
    else
      echo -e "${YELLOW}‚ö†Ô∏è  Warning: Could not create backup${NC}"
      echo -e "${YELLOW}   Proceeding anyway...${NC}"
      return 1
    fi
  fi
}

# üîí NEW: Restore function (if setup fails)
restore_from_backup() {
  LATEST_BACKUP=$(ls -1t "${CONFIG_FILE}.backup."* 2>/dev/null | head -1)
  if [ -n "$LATEST_BACKUP" ]; then
    echo ""
    echo -e "${YELLOW}‚ùå Setup failed. Restoring from backup...${NC}"
    if cp "$LATEST_BACKUP" "$CONFIG_FILE" 2>/dev/null; then
      echo -e "${GREEN}‚úÖ Configuration restored from: $LATEST_BACKUP${NC}"
    else
      echo -e "${RED}‚ùå Failed to restore backup${NC}"
    fi
  fi
}

# Main setup wizard
clear
cat << EOF
${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                            ‚ïë
‚ïë          üßÖ Tor-Guard-Relay Setup Wizard v${VERSION}          ‚ïë
‚ïë                                                            ‚ïë
‚ïë            Configure your Tor relay in 6 steps            ‚ïë
‚ïë                                                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}

This wizard will help you configure a Tor relay with optimal
settings for your network and preferences.

Press Ctrl+C at any time to cancel safely.
EOF

# Check if config exists
if [ -f "$CONFIG_FILE" ]; then
  echo ""
  echo -e "${YELLOW}‚ö†Ô∏è  Existing configuration found at:${NC}"
  echo -e "${YELLOW}   $CONFIG_FILE${NC}"
  echo ""
  
  if [ "$CREATE_BACKUP" = "true" ]; then
    echo -e "${GREEN}üîí A backup will be created before making changes.${NC}"
  else
    echo -e "${RED}‚ö†Ô∏è  Backup creation is disabled!${NC}"
  fi
  
  if [ "$AUTO_MODE" != "true" ]; then
    echo ""
    printf "Continue and overwrite existing config? [y/N]: "
    read CONFIRM
    if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
      echo -e "${YELLOW}Setup cancelled.${NC}"
      exit 0
    fi
  fi
fi

# Step 1: Nickname
print_header "Step 1: Relay Nickname"
print_step "1" "Choose a nickname for your relay"
echo ""
echo "Requirements:"
echo "  ‚Ä¢ 1-19 characters"
echo "  ‚Ä¢ Only letters and numbers"
echo "  ‚Ä¢ No spaces or special characters"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  NICKNAME="$DEFAULT_NICKNAME"
  echo -e "${GREEN}‚úì${NC} Using default: $NICKNAME"
else
  while true; do
    printf "Enter nickname [${DEFAULT_NICKNAME}]: "
    read NICKNAME
    [ -z "$NICKNAME" ] && NICKNAME="$DEFAULT_NICKNAME"
    
    if validate_nickname "$NICKNAME"; then
      echo -e "${GREEN}‚úì${NC} Nickname accepted: $NICKNAME"
      break
    else
      echo -e "${RED}‚úó${NC} Invalid nickname. Please try again."
    fi
  done
fi

# Step 2: Contact Info
print_header "Step 2: Contact Information"
print_step "2" "Provide contact information (public)"
echo ""
echo "This helps the Tor Project contact you if needed."
echo "Use an email address you're comfortable making public."
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  CONTACT="$DEFAULT_CONTACT"
  echo -e "${GREEN}‚úì${NC} Using default: $CONTACT"
else
  while true; do
    printf "Enter email [${DEFAULT_CONTACT}]: "
    read CONTACT
    [ -z "$CONTACT" ] && CONTACT="$DEFAULT_CONTACT"
    
    if validate_email "$CONTACT"; then
      echo -e "${GREEN}‚úì${NC} Contact accepted: $CONTACT"
      break
    else
      echo -e "${YELLOW}‚ö†${NC} Invalid email format, but continuing..."
      break
    fi
  done
fi

# Step 3: Port Configuration
print_header "Step 3: Port Configuration"
print_step "3" "Configure network ports"
echo ""
echo "ORPort: Main port for Tor traffic (must be accessible)"
echo "DirPort: Directory service port (optional)"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  ORPORT="$DEFAULT_ORPORT"
  DIRPORT="$DEFAULT_DIRPORT"
  echo -e "${GREEN}‚úì${NC} Using defaults: ORPort=$ORPORT, DirPort=$DIRPORT"
else
  while true; do
    printf "Enter ORPort [${DEFAULT_ORPORT}]: "
    read ORPORT
    [ -z "$ORPORT" ] && ORPORT="$DEFAULT_ORPORT"
    
    if validate_port "$ORPORT"; then
      echo -e "${GREEN}‚úì${NC} ORPort accepted: $ORPORT"
      break
    else
      echo -e "${RED}‚úó${NC} Invalid port (1-65535). Please try again."
    fi
  done
  
  while true; do
    printf "Enter DirPort [${DEFAULT_DIRPORT}]: "
    read DIRPORT
    [ -z "$DIRPORT" ] && DIRPORT="$DEFAULT_DIRPORT"
    
    if validate_port "$DIRPORT"; then
      echo -e "${GREEN}‚úì${NC} DirPort accepted: $DIRPORT"
      break
    else
      echo -e "${RED}‚úó${NC} Invalid port (1-65535). Please try again."
    fi
  done
fi

# Step 4: Bandwidth Limits
print_header "Step 4: Bandwidth Allocation"
print_step "4" "Set bandwidth limits (KB/s)"
echo ""
echo "Recommended minimums:"
echo "  ‚Ä¢ Guard relay: 1024 KB/s (1 MB/s)"
echo "  ‚Ä¢ Exit relay: 2048 KB/s (2 MB/s)"
echo "  ‚Ä¢ Bridge: 512 KB/s"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  BANDWIDTH="$DEFAULT_BANDWIDTH"
  echo -e "${GREEN}‚úì${NC} Using default: $BANDWIDTH KB/s"
else
  while true; do
    printf "Enter bandwidth limit in KB/s [${DEFAULT_BANDWIDTH}]: "
    read BANDWIDTH
    [ -z "$BANDWIDTH" ] && BANDWIDTH="$DEFAULT_BANDWIDTH"
    
    if validate_bandwidth "$BANDWIDTH"; then
      echo -e "${GREEN}‚úì${NC} Bandwidth accepted: $BANDWIDTH KB/s"
      break
    else
      echo -e "${RED}‚úó${NC} Minimum bandwidth is 256 KB/s. Please try again."
    fi
  done
fi

# Step 5: Relay Type
print_header "Step 5: Relay Type Selection"
print_step "5" "Choose relay type"
echo ""
echo "Available types:"
echo "  ${GREEN}guard${NC}  - Middle/Guard relay (recommended)"
echo "  ${YELLOW}exit${NC}   - Exit relay (requires careful consideration)"
echo "  ${BLUE}bridge${NC} - Bridge relay (helps censored users)"
echo ""

if [ "$AUTO_MODE" = "true" ]; then
  echo -e "${GREEN}‚úì${NC} Using default type: $RELAY_TYPE"
else
  printf "Enter relay type [guard/exit/bridge] [${RELAY_TYPE}]: "
  read TYPE_INPUT
  [ -n "$TYPE_INPUT" ] && RELAY_TYPE="$TYPE_INPUT"
  
  case "$RELAY_TYPE" in
    guard|exit|bridge)
      echo -e "${GREEN}‚úì${NC} Relay type: $RELAY_TYPE"
      ;;
    *)
      echo -e "${YELLOW}‚ö†${NC} Unknown type, defaulting to guard"
      RELAY_TYPE="guard"
      ;;
  esac
fi

# Step 6: Generate Configuration
print_header "Step 6: Generating Configuration"
print_step "6" "Creating torrc file"
echo ""

# üîí Create backup before overwriting
create_config_backup

# Create configuration
if ! cat > "$CONFIG_FILE" << EOF
# Tor Relay Configuration
# Generated by Tor-Guard-Relay Setup Wizard v${VERSION}
# Date: $(date '+%Y-%m-%d %H:%M:%S')

# Basic Information
Nickname $NICKNAME
ContactInfo $CONTACT

# Network Settings
ORPort $ORPORT
DirPort $DIRPORT

# Bandwidth Limits
RelayBandwidthRate $BANDWIDTH KB
RelayBandwidthBurst $((